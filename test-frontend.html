<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ API –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
        }
        
        .container {
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            color: #4a5568;
        }
        
        .section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            background: #f8fafc;
        }
        
        .section h3 {
            color: #2d3748;
            margin-top: 0;
        }
        
        input, button {
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            border: 1px solid #cbd5e0;
            border-radius: 6px;
            font-size: 14px;
        }
        
        button {
            background: #4299e1;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.2s;
        }
        
        button:hover {
            background: #3182ce;
        }
        
        button:disabled {
            background: #a0aec0;
            cursor: not-allowed;
        }
        
        .output {
            background: #1a202c;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 10px;
        }
        
        .success {
            color: #38a169;
            font-weight: bold;
        }
        
        .error {
            color: #e53e3e;
            font-weight: bold;
        }
        
        .user-info {
            background: #e6fffa;
            border: 1px solid #81e6d9;
            padding: 15px;
            border-radius: 6px;
            margin: 10px 0;
        }
        
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîê –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ API –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏</h1>
            <p>Poker Simulator 2.0 - Authentication System Test</p>
        </div>

        <!-- –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è -->
        <div class="section">
            <h3>üìù –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h3>
            <input type="email" id="registerEmail" placeholder="Email" value="test@example.com">
            <input type="password" id="registerPassword" placeholder="–ü–∞—Ä–æ–ª—å" value="Password123!">
            <button onclick="register()">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
            <div id="registerOutput" class="output"></div>
        </div>

        <!-- –í—Ö–æ–¥ -->
        <div class="section">
            <h3>üîë –í—Ö–æ–¥</h3>
            <input type="email" id="loginEmail" placeholder="Email" value="test@example.com">
            <input type="password" id="loginPassword" placeholder="–ü–∞—Ä–æ–ª—å" value="Password123!">
            <button onclick="login()">–í–æ–π—Ç–∏</button>
            <div id="loginOutput" class="output"></div>
        </div>

        <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ -->
        <div id="userSection" class="section hidden">
            <h3>üë§ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ</h3>
            <div id="userInfo" class="user-info"></div>
            <button onclick="getUserInfo()">–û–±–Ω–æ–≤–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é</button>
            <button onclick="logout()">–í—ã–π—Ç–∏</button>
            <div id="userOutput" class="output"></div>
        </div>

        <!-- –ò—Å—Ç–æ—Ä–∏—è —Ä–∞–∑–¥–∞—á -->
        <div id="handsSection" class="section hidden">
            <h3>üé¥ –ò—Å—Ç–æ—Ä–∏—è —Ä–∞–∑–¥–∞—á</h3>
            <button onclick="getHands()">–ü–æ–ª—É—á–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é</button>
            <button onclick="playHand()">–°—ã–≥—Ä–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—É—é —Ä–∞–∑–¥–∞—á—É</button>
            <div id="handsOutput" class="output"></div>
        </div>

        <!-- –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω–∞—è –ø–∞–Ω–µ–ª—å -->
        <div id="adminSection" class="section hidden">
            <h3>üëë –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ</h3>
            <button onclick="getUsers()">–ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</button>
            <input type="text" id="limitUserId" placeholder="User ID –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –ª–∏–º–∏—Ç–∞">
            <input type="number" id="newLimit" placeholder="–ù–æ–≤—ã–π –ª–∏–º–∏—Ç —Ä–∞–∑–¥–∞—á" value="100">
            <button onclick="setUserLimit()">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ª–∏–º–∏—Ç</button>
            <div id="adminOutput" class="output"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3001/api';
        let accessToken = null;
        let currentUser = null;

        // –£—Ç–∏–ª–∏—Ç–∞ –¥–ª—è HTTP –∑–∞–ø—Ä–æ—Å–æ–≤
        async function apiRequest(endpoint, options = {}) {
            const url = `${API_BASE}${endpoint}`;
            const config = {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    ...options.headers
                },
                credentials: 'include', // –í–∞–∂–Ω–æ –¥–ª—è cookies
                ...options
            };

            if (accessToken) {
                config.headers['Authorization'] = `Bearer ${accessToken}`;
            }

            try {
                const response = await fetch(url, config);
                const data = await response.json();
                return {
                    ok: response.ok,
                    status: response.status,
                    data: data
                };
            } catch (error) {
                return {
                    ok: false,
                    status: 0,
                    data: { message: `–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${error.message}` }
                };
            }
        }

        // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
        async function register() {
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            const output = document.getElementById('registerOutput');

            const result = await apiRequest('/auth/register', {
                method: 'POST',
                body: JSON.stringify({ email, password })
            });

            output.innerHTML = `–°—Ç–∞—Ç—É—Å: ${result.status}\n${JSON.stringify(result.data, null, 2)}`;
            output.className = `output ${result.ok ? 'success' : 'error'}`;
        }

        // –í—Ö–æ–¥
        async function login() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const output = document.getElementById('loginOutput');

            const result = await apiRequest('/auth/login', {
                method: 'POST',
                body: JSON.stringify({ email, password })
            });

            output.innerHTML = `–°—Ç–∞—Ç—É—Å: ${result.status}\n${JSON.stringify(result.data, null, 2)}`;
            output.className = `output ${result.ok ? 'success' : 'error'}`;

            if (result.ok && result.data.data) {
                accessToken = result.data.data.accessToken;
                currentUser = result.data.data.user;
                updateUI();
            }
        }

        // –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
        async function getUserInfo() {
            const output = document.getElementById('userOutput');
            
            const result = await apiRequest('/me');
            
            output.innerHTML = `–°—Ç–∞—Ç—É—Å: ${result.status}\n${JSON.stringify(result.data, null, 2)}`;
            output.className = `output ${result.ok ? 'success' : 'error'}`;

            if (result.ok && result.data.data) {
                currentUser = result.data.data.user;
                updateUserInfo();
            }
        }

        // –ü–æ–ª—É—á–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ —Ä–∞–∑–¥–∞—á
        async function getHands() {
            const output = document.getElementById('handsOutput');
            
            const result = await apiRequest('/me/hands');
            
            output.innerHTML = `–°—Ç–∞—Ç—É—Å: ${result.status}\n${JSON.stringify(result.data, null, 2)}`;
            output.className = `output ${result.ok ? 'success' : 'error'}`;
        }

        // –°—ã–≥—Ä–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—É—é —Ä–∞–∑–¥–∞—á—É
        async function playHand() {
            const output = document.getElementById('handsOutput');
            
            const testHand = {
                board: ['As', 'Kh', '7d'],
                action: 'check',
                pot: 100,
                timestamp: new Date().toISOString()
            };

            const result = await apiRequest('/game/play', {
                method: 'POST',
                body: JSON.stringify({ hand_data: testHand })
            });
            
            output.innerHTML = `–°—Ç–∞—Ç—É—Å: ${result.status}\n${JSON.stringify(result.data, null, 2)}`;
            output.className = `output ${result.ok ? 'success' : 'error'}`;

            if (result.ok) {
                getUserInfo(); // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
            }
        }

        // –í—ã—Ö–æ–¥
        async function logout() {
            const output = document.getElementById('userOutput');
            
            const result = await apiRequest('/auth/logout', {
                method: 'POST'
            });
            
            output.innerHTML = `–°—Ç–∞—Ç—É—Å: ${result.status}\n${JSON.stringify(result.data, null, 2)}`;
            output.className = `output ${result.ok ? 'success' : 'error'}`;

            if (result.ok) {
                accessToken = null;
                currentUser = null;
                updateUI();
            }
        }

        // –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
        async function getUsers() {
            const output = document.getElementById('adminOutput');
            
            const result = await apiRequest('/admin/users');
            
            output.innerHTML = `–°—Ç–∞—Ç—É—Å: ${result.status}\n${JSON.stringify(result.data, null, 2)}`;
            output.className = `output ${result.ok ? 'success' : 'error'}`;
        }

        async function setUserLimit() {
            const userId = document.getElementById('limitUserId').value;
            const limit = parseInt(document.getElementById('newLimit').value);
            const output = document.getElementById('adminOutput');

            if (!userId || isNaN(limit)) {
                output.innerHTML = '–û—à–∏–±–∫–∞: –£–∫–∞–∂–∏—Ç–µ User ID –∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –ª–∏–º–∏—Ç';
                output.className = 'output error';
                return;
            }

            const result = await apiRequest(`/admin/users/${userId}/limit`, {
                method: 'POST',
                body: JSON.stringify({ limit })
            });
            
            output.innerHTML = `–°—Ç–∞—Ç—É—Å: ${result.status}\n${JSON.stringify(result.data, null, 2)}`;
            output.className = `output ${result.ok ? 'success' : 'error'}`;
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
        function updateUI() {
            const userSection = document.getElementById('userSection');
            const handsSection = document.getElementById('handsSection');
            const adminSection = document.getElementById('adminSection');

            if (currentUser) {
                userSection.classList.remove('hidden');
                handsSection.classList.remove('hidden');
                updateUserInfo();

                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–¥–º–∏–Ω—Å–∫—É—é –ø–∞–Ω–µ–ª—å –µ—Å–ª–∏ –µ—Å—Ç—å –ø—Ä–∞–≤–∞
                if (currentUser.roles && currentUser.roles.includes('admin')) {
                    adminSection.classList.remove('hidden');
                }
            } else {
                userSection.classList.add('hidden');
                handsSection.classList.add('hidden');
                adminSection.classList.add('hidden');
            }
        }

        function updateUserInfo() {
            if (!currentUser) return;

            const userInfo = document.getElementById('userInfo');
            userInfo.innerHTML = `
                <strong>ID:</strong> ${currentUser.user_id}<br>
                <strong>Email:</strong> ${currentUser.email}<br>
                <strong>–õ–∏–º–∏—Ç —Ä–∞–∑–¥–∞—á:</strong> ${currentUser.hand_limit}<br>
                <strong>–†–æ–ª–∏:</strong> ${currentUser.roles.join(', ') || '–ù–µ—Ç —Ä–æ–ª–µ–π'}<br>
                <strong>–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:</strong> ${currentUser.created_at}
            `;
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        window.onload = function() {
            console.log('üîê –¢–µ—Å—Ç–æ–≤–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ API –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
            console.log('üì° API Base URL:', API_BASE);
        };
    </script>
</body>
</html> 